import{isSpace as e}from"markdown-it/lib/common/utils.mjs";const t=(e,t,n)=>{let r,i=t,a={ok:!1,pos:t,value:``};for(r=e.charCodeAt(t);t<n&&r>=48&&r<=57||r===37;)r=e.charCodeAt(++t);return a.ok=!0,a.pos=t,a.value=e.slice(i,t),a},n=(e,n,r)=>{if(e.charCodeAt(n)!==61)return null;n++;let i=e.charCodeAt(n);if(i!==120&&(i<48||i>57))return null;let a=t(e,n,r);if(n=a.pos,e.charCodeAt(n++)!==120)return null;let o=t(e,n,r);return n=o.pos,{pos:n,width:a.value,height:o.value}},r=(t,r)=>{let i=t.env,a=t.pos,o=t.posMax;if(t.src.charCodeAt(t.pos)!==33||t.src.charCodeAt(t.pos+1)!==91)return!1;let s=t.pos+2,c=t.md.helpers.parseLinkLabel(t,t.pos+1,!1);if(c<0)return!1;let l=c+1,u,d=``,f=``,p=``,m=``;if(l<o&&t.src.charCodeAt(l)===40){for(l++;l<o&&e(t.src.charCodeAt(l));)l++;if(l+5>o)return!1;let r;r=t.md.helpers.parseLinkDestination(t.src,l,t.posMax),r.ok&&(d=t.md.normalizeLink(r.str),t.md.validateLink(d)?l=r.pos:d=``);let i=l;for(;l<o&&e(t.src.charCodeAt(l));l++);r=t.md.helpers.parseLinkTitle(t.src,l,t.posMax);let s=!1;if(i!==l&&r.ok){for(f=r.str,l=r.pos;l<o;l++)if(!e(t.src.charCodeAt(l))){s=!0;break}if(!s||l+3>o)return!1}else f=``;let c=n(t.src,l,t.posMax);if(c)for({width:p,height:m,pos:l}=c;l<o&&e(t.src.charCodeAt(l));l++);if(l>=o||t.src.charCodeAt(l)!==41)return t.pos=a,!1;l++}else{let e=``;if(i.references===void 0)return!1;for(;l<o&&(u=t.src.charCodeAt(l),!(u!==32&&u!==9));l++);if(l<o&&t.src.charCodeAt(l)===91){let n=l+1;l=t.md.helpers.parseLinkLabel(t,l),l>=0?e=t.src.slice(n,l++):l=c+1}else l=c+1;e||=t.src.slice(s,c);let n=i.references[t.md.utils.normalizeReference(e)];if(!n)return t.pos=a,!1;d=n.href,f=n.title??``}if(!r){let e=t.src.slice(s,c),n=[];t.md.inline.parse(e,t.md,t.env,n);let r=t.push(`image`,`img`,0),i=[[`src`,d],[`alt`,``]];f&&i.push([`title`,f]),p&&i.push([`width`,p]),m&&i.push([`height`,m]),r.attrs=i,r.children=n,r.content=e}return t.pos=l,t.posMax=o,!0},i=e=>{e.inline.ruler.before(`emphasis`,`image`,r)},a=e=>e>=48&&e<=57,o=t=>{let n=t.length,r=t.lastIndexOf(`|`);if(r===-1)return null;let i=t.slice(0,r++).trimEnd();for(;r<n&&e(t.charCodeAt(r));)r++;if(r===n)return null;let o=r;for(;r<n&&a(t.charCodeAt(r));)r++;if(r===o||r===n)return null;let s=t.slice(o,r);for(;r<n&&e(t.charCodeAt(r));)r++;if(r===n||t.charCodeAt(r++)!==120)return null;for(;r<n&&e(t.charCodeAt(r));)r++;let c=r;for(;r<n&&a(t.charCodeAt(r));)r++;if(r===c)return null;let l=t.slice(c,r),u=Number(s),d=Number(l);if(!u&&!d)return null;for(;r<n;)if(!e(t.charCodeAt(r++)))return null;return{label:i,width:u?s:null,height:d?l:null}},s=(t,n)=>{let r=t.env,i=t.pos,a=t.posMax;if(t.src.charCodeAt(t.pos)!==33||t.src.charCodeAt(t.pos+1)!==91)return!1;let s=t.pos+2,c=t.md.helpers.parseLinkLabel(t,t.pos+1,!1);if(c<0)return!1;let l=o(t.src.slice(s,c));if(!l)return!1;let{label:u,width:d,height:f}=l,p=c+1,m=``,h=``;if(p<a&&t.src.charCodeAt(p)===40){for(p++;p<a&&e(t.src.charCodeAt(p));)p++;if(p===a)return!1;let n;n=t.md.helpers.parseLinkDestination(t.src,p,t.posMax),n.ok&&(m=t.md.normalizeLink(n.str),t.md.validateLink(m)?p=n.pos:m=``);let r=p;for(;p<a&&e(t.src.charCodeAt(p));p++);if(n=t.md.helpers.parseLinkTitle(t.src,p,t.posMax),p<a&&r!==p&&n.ok)for(h=n.str,p=n.pos;p<a&&e(t.src.charCodeAt(p));p++);else h=``;if(p>=a||t.src.charCodeAt(p)!==41)return t.pos=i,!1;p++}else{let n=``;if(r.references===void 0)return!1;for(;p<a&&e(t.src.charCodeAt(p));p++);if(p<a&&t.src.charCodeAt(p)===91){let e=p+1;p=t.md.helpers.parseLinkLabel(t,p),p>=0?n=t.src.slice(e,p++):p=c+1}else p=c+1;n||=u;let o=r.references[t.md.utils.normalizeReference(n)];if(!o)return t.pos=i,!1;m=o.href,h=o.title??``}if(!n){let e=t.push(`image`,`img`,0),n=[[`src`,m],[`alt`,``]];h&&n.push([`title`,h]),d&&n.push([`width`,d]),f&&n.push([`height`,f]);let r=[];t.md.inline.parse(u,t.md,t.env,r),e.attrs=n,e.children=r,e.content=u}return t.pos=p,t.posMax=a,!0},c=e=>{e.inline.ruler.before(`image`,`obsidian-img-size`,s)},l=e=>e>=48&&e<=57,u=t=>{let n=t.length,r=t.lastIndexOf(`=`);if(r===-1||r+3>n||r!==0&&!e(t.charCodeAt(r-1)))return null;let i=t.slice(0,r++).trimEnd(),a=null,o=null;if(l(t.charCodeAt(r))){let e=r;for(;r<n&&l(t.charCodeAt(r));)r++;if(a=t.slice(e,r),t.charCodeAt(r++)!==120)return null}else if(t.charCodeAt(r++)!==120)return null;if(r<n){let e=r;for(;r<n&&l(t.charCodeAt(r));)r++;r>e&&(o=t.slice(e,r))}for(;r<n;){if(!e(t.charCodeAt(r)))return null;r++}return{label:i,width:a,height:o}},d=(t,n)=>{let r=t.env,i=t.pos,a=t.posMax;if(t.src.charCodeAt(t.pos)!==33||t.src.charCodeAt(t.pos+1)!==91)return!1;let o=t.pos+2,s=t.md.helpers.parseLinkLabel(t,t.pos+1,!1);if(s<0)return!1;let c=u(t.src.slice(o,s));if(!c)return!1;let{label:l,width:d,height:f}=c,p=s+1,m=``,h=``;if(p<a&&t.src.charCodeAt(p)===40){for(p++;p<a&&e(t.src.charCodeAt(p));)p++;if(p>=a)return!1;let n;n=t.md.helpers.parseLinkDestination(t.src,p,t.posMax),n.ok&&(m=t.md.normalizeLink(n.str),t.md.validateLink(m)?p=n.pos:m=``);let r=p;for(;p<a&&e(t.src.charCodeAt(p));p++);if(n=t.md.helpers.parseLinkTitle(t.src,p,t.posMax),p<a&&r!==p&&n.ok)for(h=n.str,p=n.pos;p<a&&e(t.src.charCodeAt(p));p++);else h=``;if(p>=a||t.src.charCodeAt(p)!==41)return t.pos=i,!1;p++}else{let n=``;if(r.references===void 0)return!1;for(;p<a&&e(t.src.charCodeAt(p));p++);if(p<a&&t.src.charCodeAt(p)===91){let e=p+1;p=t.md.helpers.parseLinkLabel(t,p),p>=0?n=t.src.slice(e,p++):p=s+1}else p=s+1;n||=l;let o=r.references[t.md.utils.normalizeReference(n)];if(!o)return t.pos=i,!1;m=o.href,h=o.title??``}if(!n){let e=t.push(`image`,`img`,0),n=[[`src`,m],[`alt`,``]];h&&n.push([`title`,h]),d&&n.push([`width`,d]),f&&n.push([`height`,f]);let r=[];t.md.inline.parse(l,t.md,t.env,r),e.attrs=n,e.children=r,e.content=l}return t.pos=p,t.posMax=a,!0},f=e=>{e.inline.ruler.before(`image`,`img-size`,d)};export{f as imgSize,d as imgSizeRule,i as legacyImgSize,c as obsidianImgSize,s as obsidianImgSizeRule};
//# sourceMappingURL=index.js.map