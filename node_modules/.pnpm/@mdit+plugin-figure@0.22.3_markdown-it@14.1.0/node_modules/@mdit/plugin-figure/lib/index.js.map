{"version":3,"file":"index.js","names":[],"sources":["../src/plugin.ts"],"sourcesContent":["/**\n * Forked and modified from https://github.com/Antonio-Laguna/markdown-it-image-figures\n */\nimport type { PluginWithOptions } from \"markdown-it\";\nimport type { RuleCore } from \"markdown-it/lib/parser_core.mjs\";\nimport type Token from \"markdown-it/lib/token.mjs\";\n\nimport type { MarkdownItFigureOptions } from \"./options.js\";\n\nconst removeAttribute = (token: Token, attribute: string): void => {\n  token.attrs = token.attrs?.filter(([key]) => key !== attribute) ?? null;\n};\n\nconst getCaption = (image: Token): string => {\n  const title = image.attrs?.find(([attr]) => attr === \"title\")?.[1];\n\n  if (title) {\n    removeAttribute(image, \"title\");\n\n    return title;\n  }\n\n  return image.content;\n};\n\nexport const figure: PluginWithOptions<MarkdownItFigureOptions> = (md, options = {}) => {\n  const figureRule: RuleCore = (state) => {\n    // do not process first and last token\n    for (let index = 1, { length } = state.tokens; index < length - 1; index++) {\n      const token = state.tokens[index];\n\n      if (token.type !== \"inline\") continue;\n\n      // children: image alone, or link_open -> image -> link_close\n      if (!token.children || (token.children.length !== 1 && token.children.length !== 3)) continue;\n\n      // one child, should be img\n      if (token.children.length === 1 && token.children[0].type !== \"image\") continue;\n\n      // three children, should be image enclosed in link\n      if (token.children.length === 3) {\n        const [childrenA, childrenB, childrenC] = token.children;\n        const isEnclosed =\n          childrenA.type !== \"link_open\" ||\n          childrenB.type !== \"image\" ||\n          childrenC.type !== \"link_close\";\n\n        if (isEnclosed) continue;\n      }\n\n      // prev token is paragraph open\n      if (state.tokens[index - 1].type !== \"paragraph_open\") continue;\n\n      // next token is paragraph close\n      if (state.tokens[index + 1].type !== \"paragraph_close\") continue;\n\n      // We have inline token containing an image only.\n      // Previous token is paragraph open.\n      // Next token is paragraph close.\n      // Lets replace the paragraph tokens with figure tokens.\n      const figure = state.tokens[index - 1];\n\n      figure.type = \"figure_open\";\n      figure.tag = \"figure\";\n      state.tokens[index + 1].type = \"figure_close\";\n      state.tokens[index + 1].tag = \"figure\";\n\n      // for linked images, image is one off\n      const image = token.children.length === 1 ? token.children[0] : token.children[1];\n\n      const figCaption = getCaption(image);\n      const [captionContent] = md.parseInline(figCaption, state.env);\n\n      token.children.push(new state.Token(\"figcaption_open\", \"figcaption\", 1));\n      token.children.push(...(captionContent.children ?? []));\n      token.children.push(new state.Token(\"figcaption_close\", \"figcaption\", -1));\n\n      if (options.focusable !== false) image.attrPush([\"tabindex\", \"0\"]);\n    }\n  };\n\n  md.core.ruler.before(\"linkify\", \"figure\", figureRule);\n};\n"],"mappings":"AASA,MAAM,GAAmB,EAAc,IAA4B,CACjE,EAAM,MAAQ,EAAM,OAAO,QAAQ,CAAC,KAAS,IAAQ,EAAU,EAAI,MAG/D,EAAc,GAAyB,CAC3C,IAAM,EAAQ,EAAM,OAAO,MAAM,CAAC,KAAU,IAAS,QAAQ,GAAG,GAQhE,OANI,GACF,EAAgB,EAAO,QAAQ,CAExB,GAGF,EAAM,SAGF,GAAsD,EAAI,EAAU,EAAE,GAAK,CAwDtF,EAAG,KAAK,MAAM,OAAO,UAAW,SAvDF,GAAU,CAEtC,IAAK,IAAI,EAAQ,EAAG,CAAE,UAAW,EAAM,OAAQ,EAAQ,EAAS,EAAG,IAAS,CAC1E,IAAM,EAAQ,EAAM,OAAO,GAQ3B,GANI,EAAM,OAAS,UAGf,CAAC,EAAM,UAAa,EAAM,SAAS,SAAW,GAAK,EAAM,SAAS,SAAW,GAG7E,EAAM,SAAS,SAAW,GAAK,EAAM,SAAS,GAAG,OAAS,QAAS,SAGvE,GAAI,EAAM,SAAS,SAAW,EAAG,CAC/B,GAAM,CAAC,EAAW,EAAW,GAAa,EAAM,SAMhD,GAJE,EAAU,OAAS,aACnB,EAAU,OAAS,SACnB,EAAU,OAAS,aAEL,SAOlB,GAHI,EAAM,OAAO,EAAQ,GAAG,OAAS,kBAGjC,EAAM,OAAO,EAAQ,GAAG,OAAS,kBAAmB,SAMxD,IAAM,EAAS,EAAM,OAAO,EAAQ,GAEpC,EAAO,KAAO,cACd,EAAO,IAAM,SACb,EAAM,OAAO,EAAQ,GAAG,KAAO,eAC/B,EAAM,OAAO,EAAQ,GAAG,IAAM,SAG9B,IAAM,EAAQ,EAAM,SAAS,SAAW,EAAI,EAAM,SAAS,GAAK,EAAM,SAAS,GAEzE,EAAa,EAAW,EAAM,CAC9B,CAAC,GAAkB,EAAG,YAAY,EAAY,EAAM,IAAI,CAE9D,EAAM,SAAS,KAAK,IAAI,EAAM,MAAM,kBAAmB,aAAc,EAAE,CAAC,CACxE,EAAM,SAAS,KAAK,GAAI,EAAe,UAAY,EAAE,CAAE,CACvD,EAAM,SAAS,KAAK,IAAI,EAAM,MAAM,mBAAoB,aAAc,GAAG,CAAC,CAEtE,EAAQ,YAAc,IAAO,EAAM,SAAS,CAAC,WAAY,IAAI,CAAC,GAIjB"}