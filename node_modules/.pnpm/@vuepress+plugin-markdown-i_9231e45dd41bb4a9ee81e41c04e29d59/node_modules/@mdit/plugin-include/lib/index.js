import e from"node:fs";import{NEWLINE_RE as t,dedent as n}from"@mdit/helper";import r from"upath";const i=[/^\/\/ ?#?((?:end)?region) ([\w*-]+)$/,/^\/\* ?#((?:end)?region) ([\w*-]+) ?\*\/$/,/^#pragma ((?:end)?region) ([\w*-]+)$/,/^<!-- #?((?:end)?region) ([\w*-]+) -->$/,/^#((?:End )Region) ([\w*-]+)$/,/^::#((?:end)region) ([\w*-]+)$/,/^# ?((?:end)?region) ([\w*-]+)$/],a=/^( *)<!-{2,}\s*@include:\s*([^<>|:"*?]+(?:\.[a-z0-9]+))(?:#([\w-]+))?(?:\{(\d+)?-(\d+)?\})?\s*-{2,}>\s*$/gm,o=/^( *)@include:\s*([^<>|:"*?]+(?:\.[a-z0-9]+))(?:#([\w-]+))?(?:\{(\d+)?-(\d+)?\})?\s*$/gm,s=(e,t,n,r=!1)=>{let[i,a,o]=t.exec(e.trim())??[];return!!(i&&a&&o===n&&a.match(r?/^[Ee]nd ?[rR]egion$/:/^[rR]egion$/))},c=(e,t)=>{let n=null,r=-1,a=e.length;for(let o=0;o<a;o++){let a=e[o];if(n===null)for(let e=0;e<i.length;e++){let c=i[e];if(s(a,c,t)){r=o+1,n=c;break}}else if(s(a,n,t,!0))return{lineStart:r,lineEnd:o}}return null},l=(i,{cwd:a,includedFiles:o,resolvedPath:s})=>{let{filePath:l}=i,u=l;if(!r.isAbsolute(l)){if(!a)return console.error(`[@mdit/plugin-include]: Error when resolving path: ${l}`),`
Error when resolving path
`;u=r.resolve(a,l)}if(o.push(u),!e.existsSync(u))return console.error(`[@mdit/plugin-include]: ${u} not found`),`
File not found
`;let d=e.readFileSync(u).toString().replace(t,`
`).split(`
`),f=[];if(`region`in i){let e=c(d,i.region);e&&(f=d.slice(e.lineStart,e.lineEnd))}else{let{lineStart:e,lineEnd:t}=i;if(e)f=d.slice(e-1,t);else if(d[0]===`---`){let e=d.findIndex((e,t)=>t!==0&&e===`---`);f=d.slice(Math.max(e+1,1),t)}else f=d.slice(0,t)}if(s&&u.endsWith(`.md`)){let e=r.dirname(u);f.unshift(`<!-- #include-env-start: ${e} -->`),f.push(`<!-- #include-env-end -->`)}return n(f.join(`
`).replace(/\n?$/,`
`))},u=(e,t,{cwd:n,includedFiles:i})=>e.replace(t.useComment?a:o,(e,a,o,s,c,d)=>{let f=t.resolvePath(o,n),p=t.resolveImagePath||t.resolveLinkPath,m=l(Object.assign({filePath:f},s?{region:s}:{lineStart:c?Number(c):void 0,lineEnd:d?Number(d):void 0}),{cwd:n,includedFiles:i,resolvedPath:p});return(t.deep&&f.endsWith(`.md`)?u(m,t,{cwd:r.isAbsolute(f)?r.dirname(f):n?r.resolve(n,r.dirname(f)):null,includedFiles:i}):m).split(`
`).map(e=>a+e).join(`
`)}),d=/^<!-- #include-env-start: ([^)]*?) -->$/,f=(e,t,n,r)=>{let i=e.bMarks[t]+e.tShift[t],a=e.eMarks[t],o=e.src.slice(i,a);if(o.startsWith(`<!-- #include-env-start: `)){let n=d.exec(o);if(n){if(r)return!0;let[,i]=n;e.line=t+1;let a=e.push(`include_start`,``,0);return a.map=[t,e.line],a.info=i,a.markup=`include_start`,!0}}return!1},p=(e,t,n,r)=>{let i=e.bMarks[t]+e.tShift[t],a=e.eMarks[t];if(e.src.slice(i,a)===`<!-- #include-env-end -->`){if(r)return!0;e.line=t+1;let n=e.push(`include_end`,``,0);return n.map=[t,e.line],n.markup=`include_end`,!0}return!1},m=(e,t,n,i)=>{let a=t.attrIndex(e),o=t.attrs?.[a][1];if(o?.[0]===`.`&&Array.isArray(i)){let{length:e}=i;if(e){let s=r.relative(r.dirname(n),i[e-1]),c=r.join(s,o);t.attrs[a][1]=c[0]===`.`?c:`./${c}`}}},h=(e,t)=>{let{currentPath:n,resolvePath:i=e=>e,deep:a=!1,resolveLinkPath:o=!0,resolveImagePath:s=!0,useComment:c=!0}=t??{};if(typeof n!=`function`)throw TypeError(`[@mdit/plugin-include]: "currentPath" is required`);if(e.core.ruler.after(`normalize`,`md_import`,e=>{let t=e.env,l=t.includedFiles??=[],d=n(t);e.src=u(e.src,{currentPath:n,resolvePath:i,deep:a,resolveLinkPath:o,resolveImagePath:s,useComment:c},{cwd:d?r.dirname(d):null,includedFiles:l})}),s||o){if(e.block.ruler.before(`table`,`md_include_start`,f,{alt:[`paragraph`,`reference`,`blockquote`,`list`]}),e.block.ruler.before(`table`,`md_include_end`,p,{alt:[`paragraph`,`reference`,`blockquote`,`list`]}),e.renderer.rules.include_start=(e,t,n,r)=>{let i=e[t];return(r.includedPaths??=[]).push(i.info),``},e.renderer.rules.include_end=(e,t,n,r)=>{let i=r.includedPaths;return Array.isArray(i)?i.pop():console.error(`[@mdit/plugin-include]: include_end failed, no include_start.`),``},s){let t=e.renderer.rules.image;e.renderer.rules.image=(e,r,i,a,o)=>{let s=e[r],c=n(a);return c&&m(`src`,s,c,a.includedPaths),t(e,r,i,a,o)}}if(o){let t=e.renderer.rules.link_open??((e,t,n,r,i)=>i.renderToken(e,t,n));e.renderer.rules.link_open=(e,r,i,a,o)=>{let s=e[r],c=n(a);return c&&m(`href`,s,c,a.includedPaths),t(e,r,i,a,o)}}}};export{l as handleInclude,h as include,u as resolveInclude};
//# sourceMappingURL=index.js.map