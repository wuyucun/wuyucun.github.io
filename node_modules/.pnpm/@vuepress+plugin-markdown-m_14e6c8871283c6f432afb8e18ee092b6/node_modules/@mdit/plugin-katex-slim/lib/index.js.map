{"version":3,"file":"index.js","names":[],"sources":["../src/plugin.ts"],"sourcesContent":["// oxlint-disable typescript/consistent-type-imports\n\nimport { escapeHtml } from \"@mdit/helper\";\nimport { tex } from \"@mdit/plugin-tex\";\nimport type { KatexOptions, KatexOptions as OriginalKatexOptions } from \"katex\";\nimport type MarkdownIt from \"markdown-it\";\n\nimport type { MarkdownItKatexOptions, TeXTransformer } from \"./options.js\";\n\nlet isKatexInstalled = true;\nlet katexLib: typeof import(\"katex\");\n\ntry {\n  katexLib = await import(\"katex\");\n} catch {\n  /* istanbul ignore next -- @preserve */\n  isKatexInstalled = false;\n}\n\nconst katexInline = (\n  tex: string,\n  options: OriginalKatexOptions,\n  transformer?: TeXTransformer,\n): string => {\n  let result: string;\n\n  try {\n    result = katexLib.renderToString(tex, options);\n  } catch (err) {\n    /* istanbul ignore else -- @preserve */\n    if (err instanceof katexLib.ParseError) {\n      // oxlint-disable-next-line no-console\n      console.error(err);\n      result = `<span class='katex-error' title='${escapeHtml(\n        (err as Error).toString(),\n      )}'>${escapeHtml(tex)}</span>`;\n    } else {\n      throw err;\n    }\n  }\n\n  return transformer?.(result, false) ?? result;\n};\n\nconst katexBlock = (\n  tex: string,\n  options: OriginalKatexOptions,\n  transformer?: TeXTransformer,\n): string => {\n  let result: string;\n\n  try {\n    result = `<p class='katex-block'>${katexLib.renderToString(tex, options)}</p>\\n`;\n  } catch (err) {\n    /* istanbul ignore else -- @preserve */\n    if (err instanceof katexLib.ParseError) {\n      // oxlint-disable-next-line no-console\n      console.error(err);\n      result = `<p class='katex-block katex-error' title='${escapeHtml(\n        (err as Error).toString(),\n      )}'>${escapeHtml(tex)}</p>\\n`;\n    } else {\n      throw err;\n    }\n  }\n\n  return transformer?.(result, true) ?? result;\n};\n\nexport const katex = <MarkdownItEnv = unknown>(\n  md: MarkdownIt,\n  {\n    allowInlineWithSpace = false,\n    delimiters,\n    mathFence,\n    logger = (errorCode: string): \"ignore\" | \"warn\" | \"error\" | boolean | undefined =>\n      errorCode === \"newLineInDisplayMode\" ? \"ignore\" : \"warn\",\n    transformer,\n    ...userOptions\n  }: MarkdownItKatexOptions<MarkdownItEnv> = {},\n): void => {\n  /* istanbul ignore if -- @preserve */\n  if (!isKatexInstalled) throw new Error('[@mdit/plugin-katex-slim]: \"katex\" is not installed!');\n\n  const commonKatexOptions: KatexOptions = Object.assign(\n    {\n      // see https://github.com/vuepress/ecosystem/issues/261\n      // this ensures that `\\gdef` works as expected macros: {},\n      macros: {},\n      throwOnError: false,\n    },\n    userOptions,\n  );\n\n  md.use(tex, {\n    allowInlineWithSpace,\n    delimiters,\n    mathFence,\n    render: (content: string, displayMode: boolean, env: MarkdownItEnv) => {\n      const katexOptions = Object.assign<KatexOptions, KatexOptions, KatexOptions>(\n        {},\n        commonKatexOptions,\n        {\n          strict: (errorCode, errorMsg, token) =>\n            // oxlint-disable-next-line typescript/no-unnecessary-condition\n            logger(errorCode, errorMsg, token, env) ?? \"ignore\",\n          displayMode,\n        },\n      );\n\n      return displayMode\n        ? katexBlock(content, katexOptions, transformer)\n        : katexInline(content, katexOptions, transformer);\n    },\n  });\n};\n"],"mappings":"iFASA,IAAI,EAAmB,GACnB,EAEJ,GAAI,CACF,EAAW,MAAM,OAAO,cAClB,CAEN,EAAmB,GAGrB,MAAM,GACJ,EACA,EACA,IACW,CACX,IAAI,EAEJ,GAAI,CACF,EAAS,EAAS,eAAe,EAAK,EAAQ,OACvC,EAAK,CAEZ,GAAI,aAAe,EAAS,WAE1B,QAAQ,MAAM,EAAI,CAClB,EAAS,oCAAoC,EAC1C,EAAc,UAAU,CAC1B,CAAC,IAAI,EAAW,EAAI,CAAC,cAEtB,MAAM,EAIV,OAAO,IAAc,EAAQ,GAAM,EAAI,GAGnC,GACJ,EACA,EACA,IACW,CACX,IAAI,EAEJ,GAAI,CACF,EAAS,0BAA0B,EAAS,eAAe,EAAK,EAAQ,CAAC,cAClE,EAAK,CAEZ,GAAI,aAAe,EAAS,WAE1B,QAAQ,MAAM,EAAI,CAClB,EAAS,6CAA6C,EACnD,EAAc,UAAU,CAC1B,CAAC,IAAI,EAAW,EAAI,CAAC,aAEtB,MAAM,EAIV,OAAO,IAAc,EAAQ,GAAK,EAAI,GAG3B,GACX,EACA,CACE,uBAAuB,GACvB,aACA,YACA,SAAU,GACR,IAAc,uBAAyB,SAAW,OACpD,cACA,GAAG,GACsC,EAAE,GACpC,CAET,GAAI,CAAC,EAAkB,MAAU,MAAM,uDAAuD,CAE9F,IAAM,EAAmC,OAAO,OAC9C,CAGE,OAAQ,EAAE,CACV,aAAc,GACf,CACD,EACD,CAED,EAAG,IAAI,EAAK,CACV,uBACA,aACA,YACA,QAAS,EAAiB,EAAsB,IAAuB,CACrE,IAAM,EAAe,OAAO,OAC1B,EAAE,CACF,EACA,CACE,QAAS,EAAW,EAAU,IAE5B,EAAO,EAAW,EAAU,EAAO,EAAI,EAAI,SAC7C,cACD,CACF,CAED,OAAO,EACH,EAAW,EAAS,EAAc,EAAY,CAC9C,EAAY,EAAS,EAAc,EAAY,EAEtD,CAAC"}