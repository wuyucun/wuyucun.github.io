{"version":3,"file":"index.js","sources":["../src/tex/packages.ts","../src/tex/loader.ts","../src/tex/utils.ts","../src/plugin.ts"],"sourcesContent":["import type { TexPackage } from \"../mathjax.js\";\n\nexport const texPackages: TexPackage[] = [\n  \"action\",\n  \"ams\",\n  \"amscd\",\n  \"bbm\",\n  \"bboldx\",\n  \"bbox\",\n  \"begingroup\",\n  \"boldsymbol\",\n  \"braket\",\n  \"bussproofs\",\n  \"cancel\",\n  \"cases\",\n  \"centernot\",\n  \"color\",\n  \"colortbl\",\n  \"colorv2\",\n  \"configmacros\",\n  \"dsfont\",\n  \"empheq\",\n  \"enclose\",\n  \"extpfeil\",\n  \"gensymb\",\n  \"html\",\n  \"mathtools\",\n  \"mhchem\",\n  \"newcommand\",\n  \"noerrors\",\n  \"noundefined\",\n  \"physics\",\n  \"setoptions\",\n  \"tagformat\",\n  \"texhtml\",\n  \"textcomp\",\n  \"textmacros\",\n  \"unicode\",\n  \"units\",\n  \"upgreek\",\n  \"verb\",\n];\n","import type { TexPackage } from \"../mathjax.js\";\n\nexport const texLoaders: Record<TexPackage, () => Promise<unknown>> = {\n  action: () =>\n    import(\"@mathjax/src/js/input/tex/action/ActionConfiguration.js\"),\n  ams: () => import(\"@mathjax/src/js/input/tex/ams/AmsConfiguration.js\"),\n  amscd: () => import(\"@mathjax/src/js/input/tex/amscd/AmsCdConfiguration.js\"),\n  bbm: () => import(\"@mathjax/src/js/input/tex/bbm/BbmConfiguration.js\"),\n  bboldx: () =>\n    import(\"@mathjax/src/js/input/tex/bboldx/BboldxConfiguration.js\"),\n  bbox: () => import(\"@mathjax/src/js/input/tex/bbox/BboxConfiguration.js\"),\n  begingroup: () =>\n    import(\"@mathjax/src/js/input/tex/begingroup/BegingroupConfiguration.js\"),\n  boldsymbol: () =>\n    import(\"@mathjax/src/js/input/tex/boldsymbol/BoldsymbolConfiguration.js\"),\n  braket: () =>\n    import(\"@mathjax/src/js/input/tex/braket/BraketConfiguration.js\"),\n  bussproofs: () =>\n    import(\"@mathjax/src/js/input/tex/bussproofs/BussproofsConfiguration.js\"),\n  cancel: () =>\n    import(\"@mathjax/src/js/input/tex/cancel/CancelConfiguration.js\"),\n  cases: () => import(\"@mathjax/src/js/input/tex/cases/CasesConfiguration.js\"),\n  centernot: () =>\n    import(\"@mathjax/src/js/input/tex/centernot/CenternotConfiguration.js\"),\n  color: () => import(\"@mathjax/src/js/input/tex/color/ColorConfiguration.js\"),\n  colortbl: () =>\n    import(\"@mathjax/src/js/input/tex/colortbl/ColortblConfiguration.js\"),\n  colorv2: () =>\n    import(\"@mathjax/src/js/input/tex/colorv2/ColorV2Configuration.js\"),\n  configmacros: () =>\n    import(\"@mathjax/src/js/input/tex/configmacros/ConfigMacrosConfiguration.js\"),\n  dsfont: () =>\n    import(\"@mathjax/src/js/input/tex/dsfont/DsfontConfiguration.js\"),\n  empheq: () =>\n    import(\"@mathjax/src/js/input/tex/empheq/EmpheqConfiguration.js\"),\n  enclose: () =>\n    import(\"@mathjax/src/js/input/tex/enclose/EncloseConfiguration.js\"),\n  extpfeil: () =>\n    import(\"@mathjax/src/js/input/tex/extpfeil/ExtpfeilConfiguration.js\"),\n  gensymb: () =>\n    import(\"@mathjax/src/js/input/tex/gensymb/GensymbConfiguration.js\"),\n  html: () => import(\"@mathjax/src/js/input/tex/html/HtmlConfiguration.js\"),\n  mathtools: () =>\n    import(\"@mathjax/src/js/input/tex/mathtools/MathtoolsConfiguration.js\"),\n  mhchem: () =>\n    import(\"@mathjax/src/js/input/tex/mhchem/MhchemConfiguration.js\"),\n  newcommand: () =>\n    import(\"@mathjax/src/js/input/tex/newcommand/NewcommandConfiguration.js\"),\n  noerrors: () =>\n    import(\"@mathjax/src/js/input/tex/noerrors/NoErrorsConfiguration.js\"),\n  noundefined: () =>\n    import(\"@mathjax/src/js/input/tex/noundefined/NoUndefinedConfiguration.js\"),\n  physics: () =>\n    import(\"@mathjax/src/js/input/tex/physics/PhysicsConfiguration.js\"),\n  setoptions: () =>\n    import(\"@mathjax/src/js/input/tex/setoptions/SetOptionsConfiguration.js\"),\n  tagformat: () =>\n    import(\"@mathjax/src/js/input/tex/tagformat/TagFormatConfiguration.js\"),\n  texhtml: () =>\n    import(\"@mathjax/src/js/input/tex/texhtml/TexHtmlConfiguration.js\"),\n  textcomp: () =>\n    import(\"@mathjax/src/js/input/tex/textcomp/TextcompConfiguration.js\"),\n  textmacros: () =>\n    import(\"@mathjax/src/js/input/tex/textmacros/TextMacrosConfiguration.js\"),\n  unicode: () =>\n    import(\"@mathjax/src/js/input/tex/unicode/UnicodeConfiguration.js\"),\n  units: () => import(\"@mathjax/src/js/input/tex/units/UnitsConfiguration.js\"),\n  upgreek: () =>\n    import(\"@mathjax/src/js/input/tex/upgreek/UpgreekConfiguration.js\"),\n  verb: () => import(\"@mathjax/src/js/input/tex/verb/VerbConfiguration.js\"),\n};\n","import type { TexPackage } from \"../mathjax.js\";\nimport { texLoaders } from \"./loader.js\";\nimport { texPackages } from \"./packages.js\";\n\nexport const loadTexPackages = async (\n  packages: TexPackage[] = texPackages,\n): Promise<void> => {\n  await import(\"@mathjax/src/js/input/tex/base/BaseConfiguration.js\");\n\n  await Promise.all(\n    packages\n      .filter((pkg) => texPackages.includes(pkg))\n      .map((pkg) => texLoaders[pkg]()),\n  );\n};\n","/**\n * Forked from https://github.com/tani/markdown-it-mathjax3/blob/master/index.ts\n */\n\nimport type { AssistiveMmlHandler as AssistiveMmlHandlerType } from \"@mathjax/src/js/a11y/assistive-mml.js\";\nimport type { LiteDocument } from \"@mathjax/src/js/adaptors/lite/Document.js\";\nimport type {\n  LiteElement,\n  LiteNode,\n} from \"@mathjax/src/js/adaptors/lite/Element.js\";\nimport type { LiteText } from \"@mathjax/src/js/adaptors/lite/Text.js\";\nimport type {\n  LiteAdaptor,\n  liteAdaptor as liteAdaptorType,\n} from \"@mathjax/src/js/adaptors/liteAdaptor.js\";\nimport type { MathDocument } from \"@mathjax/src/js/core/MathDocument.js\";\nimport type { RegisterHTMLHandler as RegisterHTMLHandlerType } from \"@mathjax/src/js/handlers/html.js\";\nimport type { TeX as TeXType } from \"@mathjax/src/js/input/tex.js\";\nimport type { mathjax as mathjaxType } from \"@mathjax/src/js/mathjax.js\";\nimport type { CHTML as CHTMLType } from \"@mathjax/src/js/output/chtml.js\";\nimport type { SVG as SVGType } from \"@mathjax/src/js/output/svg.js\";\nimport { tex } from \"@mdit/plugin-tex\";\nimport type MarkdownIt from \"markdown-it\";\n\nimport type { MarkdownItMathjaxOptions, TeXTransformer } from \"./options.js\";\nimport { loadTexPackages, texPackages } from \"./tex/index.js\";\n\nlet isMathJaxFullInstalled = true;\nlet mathjaxLib: typeof mathjaxType;\nlet TeX: typeof TeXType;\nlet CHTML: typeof CHTMLType;\nlet SVG: typeof SVGType;\nlet liteAdaptor: typeof liteAdaptorType;\n// move type import to front\nlet RegisterHTMLHandler: typeof RegisterHTMLHandlerType;\nlet AssistiveMmlHandler: typeof AssistiveMmlHandlerType;\n\ntry {\n  ({ mathjax: mathjaxLib } = await import(\"@mathjax/src/js/mathjax.js\"));\n  ({ TeX } = await import(\"@mathjax/src/js/input/tex.js\"));\n  ({ CHTML } = await import(\"@mathjax/src/js/output/chtml.js\"));\n  ({ SVG } = await import(\"@mathjax/src/js/output/svg.js\"));\n  ({ liteAdaptor } = await import(\"@mathjax/src/js/adaptors/liteAdaptor.js\"));\n  ({ RegisterHTMLHandler } = await import(\"@mathjax/src/js/handlers/html.js\"));\n  ({ AssistiveMmlHandler } =\n    await import(\"@mathjax/src/js/a11y/assistive-mml.js\"));\n} catch {\n  /* istanbul ignore next -- @preserve */\n  isMathJaxFullInstalled = false;\n}\n\nexport interface DocumentOptions {\n  InputJax: TeXType<LiteElement, string, HTMLElement>;\n  OutputJax:\n    | CHTMLType<LiteElement, string, HTMLElement>\n    | SVGType<LiteElement, string, HTMLElement>;\n  enableAssistiveMml: boolean;\n}\n\nexport const getDocumentOptions = async (\n  options: MarkdownItMathjaxOptions,\n): Promise<DocumentOptions> => {\n  /* istanbul ignore if -- @preserve */\n  if (!isMathJaxFullInstalled)\n    throw new Error(\n      '[@mdit/plugin-mathjax-slim] \"@mathjax/src\" is not installed!',\n    );\n\n  await loadTexPackages(options.tex?.packages);\n\n  return {\n    InputJax: new TeX<LiteElement, string, HTMLElement>({\n      packages: [\"base\", ...texPackages],\n      ...options.tex,\n    }),\n    OutputJax:\n      options.output === \"chtml\"\n        ? new CHTML<LiteElement, string, HTMLElement>({\n            adaptiveCSS: true,\n            ...options.chtml,\n          })\n        : new SVG<LiteElement, string, HTMLElement>({\n            fontCache: \"none\",\n            ...options.svg,\n          }),\n    enableAssistiveMml: options.a11y !== false,\n  };\n};\n\n/**\n * Mathjax instance\n */\nexport interface MathjaxInstance extends Required<\n  Pick<\n    MarkdownItMathjaxOptions,\n    \"allowInlineWithSpace\" | \"delimiters\" | \"mathFence\"\n  >\n> {\n  /**\n   * Mathjax adaptor\n   */\n  adaptor: LiteAdaptor;\n\n  /**\n   * Mathjax document options\n   */\n  documentOptions: DocumentOptions;\n\n  /**\n   * Clear style cache\n   */\n  clearStyle: () => void;\n\n  /**\n   * Output style for rendered content and clears it\n   *\n   * @returns style\n   */\n  outputStyle: () => string;\n\n  /**\n   * Reset tex (including labels)\n   */\n  reset: () => void;\n\n  /**\n   * Output content transformer\n   */\n  transformer: TeXTransformer | null;\n}\n\nexport const createMathjaxInstance = async (\n  options: MarkdownItMathjaxOptions = {},\n): Promise<MathjaxInstance | null> => {\n  const documentOptions = await getDocumentOptions(options);\n\n  const { OutputJax, InputJax } = documentOptions;\n\n  const adaptor = liteAdaptor();\n  const handler = RegisterHTMLHandler(adaptor);\n\n  if (options.a11y !== false)\n    AssistiveMmlHandler<LiteNode, LiteText, LiteDocument>(handler);\n\n  const clearStyle = (): void => {\n    // clear style cache\n    if (OutputJax instanceof CHTML) OutputJax.clearCache();\n  };\n\n  const reset = (): void => {\n    InputJax.reset();\n  };\n\n  const outputStyle = (): string => {\n    const style = adaptor.innerHTML(\n      OutputJax.styleSheet(\n        mathjaxLib.document(\"\", documentOptions) as MathDocument<\n          LiteElement,\n          string,\n          HTMLElement\n        >,\n      ),\n    );\n\n    clearStyle();\n\n    return style;\n  };\n\n  return {\n    adaptor,\n    documentOptions,\n    allowInlineWithSpace: options.allowInlineWithSpace ?? false,\n    delimiters: options.delimiters ?? \"dollars\",\n    mathFence: options.mathFence ?? false,\n    clearStyle,\n    reset,\n    outputStyle,\n    transformer: options.transformer ?? null,\n  };\n};\n\nexport const mathjax = (\n  md: MarkdownIt,\n  {\n    allowInlineWithSpace,\n    adaptor,\n    delimiters,\n    documentOptions,\n    mathFence,\n    transformer,\n  }: MathjaxInstance,\n): void => {\n  md.use(tex, {\n    allowInlineWithSpace,\n    delimiters,\n    mathFence,\n    render: (content, displayMode) => {\n      const mathDocument = mathjaxLib\n        .document(content, documentOptions)\n        .convert(content, {\n          display: displayMode,\n        }) as LiteElement;\n\n      const result = adaptor.outerHTML(mathDocument);\n\n      return transformer?.(result, displayMode) ?? result;\n    },\n  });\n};\n"],"names":["texPackages","texLoaders","loadTexPackages","packages","pkg","isMathJaxFullInstalled","mathjaxLib","TeX","CHTML","SVG","liteAdaptor","RegisterHTMLHandler","AssistiveMmlHandler","getDocumentOptions","options","createMathjaxInstance","documentOptions","OutputJax","InputJax","adaptor","handler","clearStyle","reset","outputStyle","style","mathjax","md","allowInlineWithSpace","delimiters","mathFence","transformer","tex","content","displayMode","mathDocument","result"],"mappings":"uCAEO,MAAMA,EAA4B,CACvC,SACA,MACA,QACA,MACA,SACA,OACA,aACA,aACA,SACA,aACA,SACA,QACA,YACA,QACA,WACA,UACA,eACA,SACA,SACA,UACA,WACA,UACA,OACA,YACA,SACA,aACA,WACA,cACA,UACA,aACA,YACA,UACA,WACA,aACA,UACA,QACA,UACA,MACF,ECvCaC,EAAyD,CACpE,OAAQ,IACN,OAAO,yDAAyD,EAClE,IAAK,IAAM,OAAO,mDAAmD,EACrE,MAAO,IAAM,OAAO,uDAAuD,EAC3E,IAAK,IAAM,OAAO,mDAAmD,EACrE,OAAQ,IACN,OAAO,yDAAyD,EAClE,KAAM,IAAM,OAAO,qDAAqD,EACxE,WAAY,IACV,OAAO,iEAAiE,EAC1E,WAAY,IACV,OAAO,iEAAiE,EAC1E,OAAQ,IACN,OAAO,yDAAyD,EAClE,WAAY,IACV,OAAO,iEAAiE,EAC1E,OAAQ,IACN,OAAO,yDAAyD,EAClE,MAAO,IAAM,OAAO,uDAAuD,EAC3E,UAAW,IACT,OAAO,+DAA+D,EACxE,MAAO,IAAM,OAAO,uDAAuD,EAC3E,SAAU,IACR,OAAO,6DAA6D,EACtE,QAAS,IACP,OAAO,2DAA2D,EACpE,aAAc,IACZ,OAAO,qEAAqE,EAC9E,OAAQ,IACN,OAAO,yDAAyD,EAClE,OAAQ,IACN,OAAO,yDAAyD,EAClE,QAAS,IACP,OAAO,2DAA2D,EACpE,SAAU,IACR,OAAO,6DAA6D,EACtE,QAAS,IACP,OAAO,2DAA2D,EACpE,KAAM,IAAM,OAAO,qDAAqD,EACxE,UAAW,IACT,OAAO,+DAA+D,EACxE,OAAQ,IACN,OAAO,yDAAyD,EAClE,WAAY,IACV,OAAO,iEAAiE,EAC1E,SAAU,IACR,OAAO,6DAA6D,EACtE,YAAa,IACX,OAAO,mEAAmE,EAC5E,QAAS,IACP,OAAO,2DAA2D,EACpE,WAAY,IACV,OAAO,iEAAiE,EAC1E,UAAW,IACT,OAAO,+DAA+D,EACxE,QAAS,IACP,OAAO,2DAA2D,EACpE,SAAU,IACR,OAAO,6DAA6D,EACtE,WAAY,IACV,OAAO,iEAAiE,EAC1E,QAAS,IACP,OAAO,2DAA2D,EACpE,MAAO,IAAM,OAAO,uDAAuD,EAC3E,QAAS,IACP,OAAO,2DAA2D,EACpE,KAAM,IAAM,OAAO,qDAAqD,CAC1E,EClEaC,EAAkB,MAC7BC,EAAyBH,IACP,CAClB,aAAa,qDAAqD,EAElE,MAAM,QAAQ,IACZG,EACG,OAAQC,GAAQJ,EAAY,SAASI,CAAG,CAAC,EACzC,IAAKA,GAAQH,EAAWG,CAAG,EAAA,CAAG,CACnC,CACF,ECaA,IAAIC,EAAyB,GACzBC,EACAC,EACAC,EACAC,EACAC,EAEAC,EACAC,EAEJ,GAAI,EACD,CAAE,QAASN,CAAW,EAAI,KAAM,QAAO,4BAA4B,GACnE,CAAE,IAAAC,CAAI,EAAI,aAAa,8BAA8B,EACrD,CAAE,MAAAC,CAAM,EAAI,KAAM,QAAO,iCAAiC,EAC1D,CAAE,IAAAC,CAAI,EAAI,KAAM,QAAO,+BAA+B,EACtD,CAAE,YAAAC,CAAY,EAAI,aAAa,yCAAyC,EACxE,CAAE,oBAAAC,CAAoB,EAAI,KAAM,QAAO,kCAAkC,EACzE,CAAE,oBAAAC,CAAoB,EACrB,KAAM,QAAO,uCAAuC,CACxD,MAAQ,CAAA,uCAENP,EAAyB,EAC3B,CAUO,MAAMQ,EAAqB,MAChCC,GAC6B,CAAA,qCAE7B,GAAI,CAACT,EACH,MAAM,IAAI,MACR,8DACF,EAEF,aAAMH,EAAgBY,EAAQ,KAAK,QAAQ,EAEpC,CACL,SAAU,IAAIP,EAAsC,CAClD,SAAU,CAAC,OAAQ,GAAGP,CAAW,EACjC,GAAGc,EAAQ,GACb,CAAC,EACD,UACEA,EAAQ,SAAW,QACf,IAAIN,EAAwC,CAC1C,YAAa,GACb,GAAGM,EAAQ,KACb,CAAC,EACD,IAAIL,EAAsC,CACxC,UAAW,OACX,GAAGK,EAAQ,GACb,CAAC,EACP,mBAAoBA,EAAQ,OAAS,EACvC,CACF,EA4CaC,EAAwB,MACnCD,EAAoC,CAAA,IACA,CACpC,MAAME,EAAkB,MAAMH,EAAmBC,CAAO,EAElD,CAAE,UAAAG,EAAW,SAAAC,CAAS,EAAIF,EAE1BG,EAAUT,IACVU,EAAUT,EAAoBQ,CAAO,EAEvCL,EAAQ,OAAS,IACnBF,EAAsDQ,CAAO,EAE/D,MAAMC,EAAa,IAAY,CAEzBJ,aAAqBT,GAAOS,EAAU,WAAA,CAC5C,EAEMK,EAAQ,IAAY,CACxBJ,EAAS,MAAA,CACX,EAEMK,EAAc,IAAc,CAChC,MAAMC,EAAQL,EAAQ,UACpBF,EAAU,WACRX,EAAW,SAAS,GAAIU,CAAe,CAKzC,CACF,EAEA,OAAAK,EAAAA,EAEOG,CACT,EAEA,MAAO,CACL,QAAAL,EACA,gBAAAH,EACA,qBAAsBF,EAAQ,sBAAwB,GACtD,WAAYA,EAAQ,YAAc,UAClC,UAAWA,EAAQ,WAAa,GAChC,WAAAO,EACA,MAAAC,EACA,YAAAC,EACA,YAAaT,EAAQ,aAAe,IACtC,CACF,EAEaW,EAAU,CACrBC,EACA,CACE,qBAAAC,EACA,QAAAR,EACA,WAAAS,EACA,gBAAAZ,EACA,UAAAa,EACA,YAAAC,CACF,IACS,CACTJ,EAAG,IAAIK,EAAK,CACV,qBAAAJ,EACA,WAAAC,EACA,UAAAC,EACA,OAAQ,CAACG,EAASC,IAAgB,CAChC,MAAMC,EAAe5B,EAClB,SAAS0B,EAAShB,CAAe,EACjC,QAAQgB,EAAS,CAChB,QAASC,CACX,CAAC,EAEGE,EAAShB,EAAQ,UAAUe,CAAY,EAE7C,OAAOJ,IAAcK,EAAQF,CAAW,GAAKE,CAC/C,CACF,CAAC,CACH"}