{"version":3,"file":"sync.js","sources":["../src/tex/packages.ts","../src/sync.ts"],"sourcesContent":["import type { TexPackage } from \"../mathjax.js\";\n\nexport const texPackages: TexPackage[] = [\n  \"action\",\n  \"ams\",\n  \"amscd\",\n  \"bbm\",\n  \"bboldx\",\n  \"bbox\",\n  \"begingroup\",\n  \"boldsymbol\",\n  \"braket\",\n  \"bussproofs\",\n  \"cancel\",\n  \"cases\",\n  \"centernot\",\n  \"color\",\n  \"colortbl\",\n  \"colorv2\",\n  \"configmacros\",\n  \"dsfont\",\n  \"empheq\",\n  \"enclose\",\n  \"extpfeil\",\n  \"gensymb\",\n  \"html\",\n  \"mathtools\",\n  \"mhchem\",\n  \"newcommand\",\n  \"noerrors\",\n  \"noundefined\",\n  \"physics\",\n  \"setoptions\",\n  \"tagformat\",\n  \"texhtml\",\n  \"textcomp\",\n  \"textmacros\",\n  \"unicode\",\n  \"units\",\n  \"upgreek\",\n  \"verb\",\n];\n","/**\n * Forked from https://github.com/tani/markdown-it-mathjax3/blob/master/index.ts\n */\n\nimport type { AssistiveMmlHandler as AssistiveMmlHandlerType } from \"@mathjax/src/js/a11y/assistive-mml.js\";\nimport type { LiteDocument } from \"@mathjax/src/js/adaptors/lite/Document.js\";\nimport type {\n  LiteElement,\n  LiteNode,\n} from \"@mathjax/src/js/adaptors/lite/Element.js\";\nimport type { LiteText } from \"@mathjax/src/js/adaptors/lite/Text.js\";\nimport type {\n  LiteAdaptor,\n  liteAdaptor as liteAdaptorType,\n} from \"@mathjax/src/js/adaptors/liteAdaptor.js\";\nimport type { MathDocument } from \"@mathjax/src/js/core/MathDocument.js\";\nimport type { RegisterHTMLHandler as RegisterHTMLHandlerType } from \"@mathjax/src/js/handlers/html.js\";\nimport type { TeX as TeXType } from \"@mathjax/src/js/input/tex.js\";\nimport type { mathjax as mathjaxType } from \"@mathjax/src/js/mathjax.js\";\nimport type { CHTML as CHTMLType } from \"@mathjax/src/js/output/chtml.js\";\nimport type { SVG as SVGType } from \"@mathjax/src/js/output/svg.js\";\nimport { tex } from \"@mdit/plugin-tex\";\nimport type MarkdownIt from \"markdown-it\";\n\nimport type { MarkdownItMathjaxOptions, TeXTransformer } from \"./options.js\";\nimport { texPackages } from \"./tex/index.js\";\n\nlet isMathJaxFullInstalled = true;\nlet mathjaxLib: typeof mathjaxType;\nlet TeX: typeof TeXType;\nlet CHTML: typeof CHTMLType;\nlet SVG: typeof SVGType;\nlet liteAdaptor: typeof liteAdaptorType;\n// move type import to front\nlet RegisterHTMLHandler: typeof RegisterHTMLHandlerType;\nlet AssistiveMmlHandler: typeof AssistiveMmlHandlerType;\n\ntry {\n  ({ mathjax: mathjaxLib } = await import(\"@mathjax/src/js/mathjax.js\"));\n  ({ TeX } = await import(\"@mathjax/src/js/input/tex.js\"));\n  ({ CHTML } = await import(\"@mathjax/src/js/output/chtml.js\"));\n  ({ SVG } = await import(\"@mathjax/src/js/output/svg.js\"));\n  ({ liteAdaptor } = await import(\"@mathjax/src/js/adaptors/liteAdaptor.js\"));\n  ({ RegisterHTMLHandler } = await import(\"@mathjax/src/js/handlers/html.js\"));\n  ({ AssistiveMmlHandler } =\n    await import(\"@mathjax/src/js/a11y/assistive-mml.js\"));\n  await import(\"./tex/importer.js\");\n} catch {\n  /* istanbul ignore next -- @preserve */\n  isMathJaxFullInstalled = false;\n}\n\nexport interface DocumentOptions {\n  InputJax: TeXType<LiteElement, string, HTMLElement>;\n  OutputJax:\n    | CHTMLType<LiteElement, string, HTMLElement>\n    | SVGType<LiteElement, string, HTMLElement>;\n  enableAssistiveMml: boolean;\n}\n\nexport const getDocumentOptions = (\n  options: MarkdownItMathjaxOptions,\n): DocumentOptions => {\n  /* istanbul ignore if -- @preserve */\n  if (!isMathJaxFullInstalled)\n    throw new Error(\n      '[@mdit/plugin-mathjax-slim] \"@mathjax/src\" is not installed!',\n    );\n\n  return {\n    InputJax: new TeX<LiteElement, string, HTMLElement>({\n      packages: [\"base\", ...texPackages],\n      ...options.tex,\n    }),\n    OutputJax:\n      options.output === \"chtml\"\n        ? new CHTML<LiteElement, string, HTMLElement>({\n            adaptiveCSS: true,\n            ...options.chtml,\n          })\n        : new SVG<LiteElement, string, HTMLElement>({\n            fontCache: \"none\",\n            ...options.svg,\n          }),\n    enableAssistiveMml: options.a11y !== false,\n  };\n};\n\n/**\n * Mathjax instance\n */\nexport interface MathjaxInstance extends Required<\n  Pick<\n    MarkdownItMathjaxOptions,\n    \"allowInlineWithSpace\" | \"delimiters\" | \"mathFence\"\n  >\n> {\n  /**\n   * Mathjax adaptor\n   */\n  adaptor: LiteAdaptor;\n\n  /**\n   * Mathjax document options\n   */\n  documentOptions: DocumentOptions;\n\n  /**\n   * Clear style cache\n   */\n  clearStyle: () => void;\n\n  /**\n   * Output style for rendered content and clears it\n   *\n   * @returns style\n   */\n  outputStyle: () => string;\n\n  /**\n   * Reset tex (including labels)\n   */\n  reset: () => void;\n\n  /**\n   * Output content transformer\n   */\n  transformer: TeXTransformer | null;\n}\n\nexport const createMathjaxInstance = (\n  options: MarkdownItMathjaxOptions = {},\n): MathjaxInstance | null => {\n  const documentOptions = getDocumentOptions(options);\n\n  const { OutputJax, InputJax } = documentOptions;\n\n  const adaptor = liteAdaptor();\n  const handler = RegisterHTMLHandler(adaptor);\n\n  if (options.a11y !== false)\n    AssistiveMmlHandler<LiteNode, LiteText, LiteDocument>(handler);\n\n  const clearStyle = (): void => {\n    // clear style cache\n    if (OutputJax instanceof CHTML) OutputJax.clearCache();\n  };\n\n  const reset = (): void => {\n    InputJax.reset();\n  };\n\n  const outputStyle = (): string => {\n    const style = adaptor.innerHTML(\n      OutputJax.styleSheet(\n        mathjaxLib.document(\"\", documentOptions) as MathDocument<\n          LiteElement,\n          string,\n          HTMLElement\n        >,\n      ),\n    );\n\n    clearStyle();\n\n    return style;\n  };\n\n  return {\n    adaptor,\n    documentOptions,\n    allowInlineWithSpace: options.allowInlineWithSpace ?? false,\n    delimiters: options.delimiters ?? \"dollars\",\n    mathFence: options.mathFence ?? false,\n    clearStyle,\n    reset,\n    outputStyle,\n    transformer: options.transformer ?? null,\n  };\n};\n\nexport const mathjax = (\n  md: MarkdownIt,\n  {\n    allowInlineWithSpace,\n    adaptor,\n    delimiters,\n    documentOptions,\n    mathFence,\n    transformer,\n  }: MathjaxInstance,\n): void => {\n  md.use(tex, {\n    allowInlineWithSpace,\n    delimiters,\n    mathFence,\n    render: (content, displayMode) => {\n      const mathDocument = mathjaxLib\n        .document(content, documentOptions)\n        .convert(content, {\n          display: displayMode,\n        }) as LiteElement;\n\n      const result = adaptor.outerHTML(mathDocument);\n\n      return transformer?.(result, displayMode) ?? result;\n    },\n  });\n};\n"],"names":["texPackages","isMathJaxFullInstalled","mathjaxLib","TeX","CHTML","SVG","liteAdaptor","RegisterHTMLHandler","AssistiveMmlHandler","getDocumentOptions","options","createMathjaxInstance","documentOptions","OutputJax","InputJax","adaptor","handler","clearStyle","reset","outputStyle","style","mathjax","md","allowInlineWithSpace","delimiters","mathFence","transformer","tex","content","displayMode","mathDocument","result"],"mappings":"uCAEO,MAAMA,EAA4B,CACvC,SACA,MACA,QACA,MACA,SACA,OACA,aACA,aACA,SACA,aACA,SACA,QACA,YACA,QACA,WACA,UACA,eACA,SACA,SACA,UACA,WACA,UACA,OACA,YACA,SACA,aACA,WACA,cACA,UACA,aACA,YACA,UACA,WACA,aACA,UACA,QACA,UACA,MACF,ECdA,IAAIC,EAAyB,GACzBC,EACAC,EACAC,EACAC,EACAC,EAEAC,EACAC,EAEJ,GAAI,EACD,CAAE,QAASN,CAAW,EAAI,KAAM,QAAO,4BAA4B,GACnE,CAAE,IAAAC,CAAI,EAAI,KAAM,QAAO,8BAA8B,EACrD,CAAE,MAAAC,CAAM,EAAI,KAAM,QAAO,iCAAiC,EAC1D,CAAE,IAAAC,CAAI,EAAI,KAAM,QAAO,+BAA+B,EACtD,CAAE,YAAAC,CAAY,EAAI,KAAM,QAAO,yCAAyC,EACxE,CAAE,oBAAAC,CAAoB,EAAI,KAAM,QAAO,kCAAkC,EACzE,CAAE,oBAAAC,CAAoB,EACrB,aAAa,uCAAuC,EACtD,KAAM,QAAO,wBAAmB,CAClC,MAAQ,CAAA,uCAENP,EAAyB,EAC3B,CAUO,MAAMQ,EACXC,GACoB,CAAA,qCAEpB,GAAI,CAACT,EACH,MAAM,IAAI,MACR,8DACF,EAEF,MAAO,CACL,SAAU,IAAIE,EAAsC,CAClD,SAAU,CAAC,OAAQ,GAAGH,CAAW,EACjC,GAAGU,EAAQ,GACb,CAAC,EACD,UACEA,EAAQ,SAAW,QACf,IAAIN,EAAwC,CAC1C,YAAa,GACb,GAAGM,EAAQ,KACb,CAAC,EACD,IAAIL,EAAsC,CACxC,UAAW,OACX,GAAGK,EAAQ,GACb,CAAC,EACP,mBAAoBA,EAAQ,OAAS,EACvC,CACF,EA4CaC,EAAwB,CACnCD,EAAoC,CAAA,IACT,CAC3B,MAAME,EAAkBH,EAAmBC,CAAO,EAE5C,CAAE,UAAAG,EAAW,SAAAC,CAAS,EAAIF,EAE1BG,EAAUT,EAAAA,EACVU,EAAUT,EAAoBQ,CAAO,EAEvCL,EAAQ,OAAS,IACnBF,EAAsDQ,CAAO,EAE/D,MAAMC,EAAa,IAAY,CAEzBJ,aAAqBT,GAAOS,EAAU,YAC5C,EAEMK,EAAQ,IAAY,CACxBJ,EAAS,MAAA,CACX,EAEMK,EAAc,IAAc,CAChC,MAAMC,EAAQL,EAAQ,UACpBF,EAAU,WACRX,EAAW,SAAS,GAAIU,CAAe,CAKzC,CACF,EAEA,OAAAK,EAAAA,EAEOG,CACT,EAEA,MAAO,CACL,QAAAL,EACA,gBAAAH,EACA,qBAAsBF,EAAQ,sBAAwB,GACtD,WAAYA,EAAQ,YAAc,UAClC,UAAWA,EAAQ,WAAa,GAChC,WAAAO,EACA,MAAAC,EACA,YAAAC,EACA,YAAaT,EAAQ,aAAe,IACtC,CACF,EAEaW,EAAU,CACrBC,EACA,CACE,qBAAAC,EACA,QAAAR,EACA,WAAAS,EACA,gBAAAZ,EACA,UAAAa,EACA,YAAAC,CACF,IACS,CACTJ,EAAG,IAAIK,EAAK,CACV,qBAAAJ,EACA,WAAAC,EACA,UAAAC,EACA,OAAQ,CAACG,EAASC,IAAgB,CAChC,MAAMC,EAAe5B,EAClB,SAAS0B,EAAShB,CAAe,EACjC,QAAQgB,EAAS,CAChB,QAASC,CACX,CAAC,EAEGE,EAAShB,EAAQ,UAAUe,CAAY,EAE7C,OAAOJ,IAAcK,EAAQF,CAAW,GAAKE,CAC/C,CACF,CAAC,CACH"}