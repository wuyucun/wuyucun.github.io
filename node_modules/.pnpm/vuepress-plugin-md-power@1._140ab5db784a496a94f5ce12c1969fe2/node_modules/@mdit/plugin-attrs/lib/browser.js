const e=e=>!(e===9||e===10||e===12||e===32||e===47||e===62||e===34||e===39||e===61),t=(t,n,r)=>{let i=``,a=``,o=!0,s=!1,c=[];for(let r=n[0];r<n[1];r++){let n=t.charCodeAt(r);if(n===61&&o){o=!1;continue}if(n===46&&i===``){t.charCodeAt(r+1)===46?(i=`css-module`,r++):i=`class`,o=!1;continue}if(n===35&&i===``){i=`id`,o=!1;continue}if(n===34&&a===``&&!s){s=!0;continue}if(n===34&&s){s=!1;continue}if(n===32&&!s){if(i===``)continue;c.push([i,a]),i=``,a=``,o=!0;continue}if(!(o&&!e(n))){if(o){i+=String.fromCharCode(n);continue}a+=String.fromCharCode(n)}}return i!==``&&c.push([i,a]),r.length>0?c.filter(([e])=>r.some(t=>t instanceof RegExp?t.test(e):t===e)):c},n=(e,n,r,i)=>{e&&t(n,r,i).forEach(([t,n])=>{switch(t){case`class`:e.attrJoin(`class`,n);break;case`css-module`:e.attrJoin(`css-module`,n);break;default:e.attrPush([t,n])}})},r=(e,t)=>{if(![`start`,`end`,`only`].includes(t))throw Error(`Invalid 'where' parameter: ${t}. Expected 'start', 'end', or 'only'.`);let n=e.left,r=e.right,i=n.length,a=r.length,o=i+1+a;return e=>{if(typeof e!=`string`||e.length<o)return!1;let s,c;if(t===`start`){if(!e.startsWith(n)||(s=i,c=e.indexOf(r,i+1),c===-1))return!1;let t=c+a;if(t<e.length&&r.includes(e.charAt(t)))return!1}else if(t===`end`){if(s=e.lastIndexOf(n),s===-1||(c=e.indexOf(r,s+i+1),s+=i,c===-1||c+a!==e.length))return!1}else{if(!e.startsWith(n)||!e.endsWith(r))return!1;s=i,c=e.length-a}let l=e.charCodeAt(s),u=c-s;return(l===46||l===35?u>=2:u>=1)?[s,c]:!1}},i=(e,t)=>{let n=e[t];if(n.type===`softbreak`)return null;if(n.nesting===0)return n;let r=n.level,i=n.type.replace(`_close`,`_open`);for(;t>=0;){let n=e[t];if(n.type===i&&n.level===r)return n;t--}return null},a=(e,t)=>t>=0?e[t]:e[e.length+t],o=(e,t,n)=>{let r={match:!1,position:null,range:null},i=n.shift!==void 0,s=i?t+n.shift:n.position;if(i&&s<0)return r;let c=a(e,s);if(!c)return r;let l=Object.keys(n),u=l.length;for(let e=0;e<u;e++){let t=l[e];if(t===`shift`||t===`position`)continue;if(c[t]===void 0)return r;if(t===`children`&&Array.isArray(n.children)){if(!c.children?.length)return r;let e=n.children,t=c.children,i,a=null;if(e.every(e=>e.position!==void 0)){if(i=e.every(e=>{let n=o(t,e.position,e);return n.match?(n.range&&(a=n.range),!0):!1}),i){let{position:n}=e[e.length-1];r.position=n>=0?n:t.length+n,r.range=a}}else for(let n=0;n<t.length;n++)if(i=e.every(e=>{let r=o(t,n,e);return r.match?(r.range&&(a=r.range),!0):!1}),i){r.position=n,a&&(r.range=a);break}if(i===!1)return r;continue}let i=n[t];switch(typeof i){case`boolean`:case`number`:case`string`:if(c[t]!==i)return r;break;case`function`:{let e=i(c[t]);if(!e)return r;Array.isArray(e)&&(r.range=e);break}default:throw Error(`Unknown type of pattern test (key: ${t}). Test should be of type boolean, number, string or function.`)}}return r.match=!0,r};function s(e){switch(e){case 9:case 32:return!0}return!1}const c=e=>e,l=e=>c({name:`end of block`,tests:[{shift:0,type:`inline`,children:[{position:-1,content:r(e,`end`),type:e=>e!==`code_inline`&&e!==`math_inline`}]}],transform:(t,r,a,o)=>{let c=o[0]-e.left.length,l=t[r].children[a],{content:u}=l,d=s(u.charCodeAt(c-1)),f=r+1;for(;t[f+1]?.nesting===-1;)f++;n(i(t,f),u,o,e.allowed),l.content=u.slice(0,d?c-1:c)}}),u=e=>c({name:`code-block`,tests:[{shift:0,block:!0,info:r(e,`end`)}],transform:(t,r,i,a)=>{let o=a[0]-e.left.length,c=t[r],{info:l}=c,u=s(l.charCodeAt(o-1));n(c,l,a,e.allowed),c.info=l.slice(0,u?o-1:o)}}),d=e=>c({name:`end of block`,tests:[{shift:-1,type:`heading_open`},{shift:0,type:`inline`,children:[{position:-1,content:r(e,`end`),type:e=>e!==`code_inline`&&e!==`math_inline`}]}],transform:(t,r,a,o)=>{let c=o[0]-e.left.length,l=t[r].children[a],{content:u}=l,d=s(u.charCodeAt(c-1));n(i(t,r+1),u,o,e.allowed),l.content=u.slice(0,d?c-1:c)}}),f=e=>[c({name:`inline nesting self-close`,tests:[{shift:0,type:`inline`,children:[{shift:-1,type:e=>e===`image`||e===`code_inline`},{shift:0,type:`text`,content:r(e,`start`)}]}],transform:(t,r,i,a)=>{let o=t[r].children,s=o[i],c=o[i-1],l=e.right.length+a[1];n(c,s.content,a,e.allowed),s.content.length===l?o.splice(i,1):s.content=s.content.slice(l)}}),c({name:`inline attributes`,tests:[{shift:0,type:`inline`,children:[{shift:-1,nesting:-1},{shift:0,type:`text`,content:r(e,`start`)}]}],transform:(t,r,a,o)=>{let s=t[r].children,c=s[a],{content:l}=c,u=e.right.length+o[1];n(i(s,a-1),l,o,e.allowed),c.content=l.slice(u)}})],p=e=>[c({name:`list softbreak`,tests:[{shift:-2,type:`list_item_open`},{shift:0,type:`inline`,children:[{position:-2,type:`softbreak`},{position:-1,type:`text`,content:r(e,`only`)}]}],transform:(t,r,i,a)=>{let o=t[r].children,s=o[i],c=r-2;for(;t[c-1]?.type!==`ordered_list_open`&&t[c-1].type!==`bullet_list_open`;)c--;n(t[c-1],s.content,a,e.allowed),t[r].children=o.slice(0,-2)}}),c({name:`list double softbreak`,tests:[{shift:0,type:e=>e===`bullet_list_close`||e===`ordered_list_close`},{shift:1,type:`paragraph_open`},{shift:2,type:`inline`,content:r(e,`only`),children:e=>e.length===1},{shift:3,type:`paragraph_close`}],transform:(t,r,a,o)=>{let s=t[r+2];n(i(t,r),s.content,o,e.allowed),t.splice(r+1,3)}}),c({name:`list item end`,tests:[{shift:-2,type:`list_item_open`},{shift:0,type:`inline`,children:[{position:-1,type:`text`,content:r(e,`end`)}]}],transform:(t,r,i,a)=>{let o=t[r].children[i],c=o.content,l=a[0]-e.left.length,u=s(c.charCodeAt(l-1));n(t[r-2],c,a,e.allowed),o.content=c.slice(0,u?l-1:l)}})],m=e=>c({name:`
{.a} softbreak then curly in start`,tests:[{shift:0,type:`inline`,children:[{position:-2,type:`softbreak`},{position:-1,type:`text`,content:r(e,`only`)}]}],transform:(t,r,a,o)=>{let s=t[r].children,c=s[a],l=r+1;for(;t[l+1]?.nesting===-1;)l++;n(i(t,l),c.content,o,e.allowed),t[r].children=s.slice(0,-2)}}),h=e=>c({name:`horizontal rule`,tests:[{shift:0,type:`paragraph_open`},{shift:1,type:`inline`,children:e=>e.length===1,content:t=>{let n=0,i,a=t.charCodeAt(n++);if(a!==45&&a!==42&&a!==95)return!1;let o=1;for(;n<t.length&&(i=t.charCodeAt(n++),i===a);)o++;return o<3?!1:(s(t.charCodeAt(n-1))||n--,r(e,`end`)(t))}},{shift:2,type:`paragraph_close`}],transform:(t,r,i,a)=>{let o=t[r],{content:s}=t[r+1];o.type=`hr`,o.tag=`hr`,o.nesting=0,n(o,s,a,e.allowed),o.markup=s,t.splice(r+1,2)}}),g=e=>[c({name:`table`,tests:[{shift:0,type:`table_close`},{shift:1,type:`paragraph_open`},{shift:2,type:`inline`,content:r(e,`only`)}],transform:(t,r,a,o)=>{let s=t[r+2];n(i(t,r),s.content,o,e.allowed),t.splice(r+1,3)}}),c({name:`table cell attributes`,tests:[{shift:-1,type:e=>e===`td_open`||e===`th_open`},{shift:0,type:`inline`,children:[{shift:0,type:`text`,content:r(e,`end`)}]}],transform:(t,r,i,a)=>{let o=a[0]-e.left.length,c=t[r].children[i],l=t[r-1],{content:u}=c,d=s(u.charCodeAt(o-1));n(l,u,a,e.allowed),c.content=u.slice(0,d?o-1:o)}}),c({name:`table thead metadata`,tests:[{shift:0,type:`tr_close`},{shift:1,type:`thead_close`},{shift:2,type:`tbody_open`}],transform:(e,t)=>{let n=i(e,t),r=e[t-1],a=0,o=t-1;for(;o>0;){let t=e[o];if(t===n){let t=e[o-1];t.meta={...t.meta,columnCount:a};break}t.level===r.level&&t.type===r.type&&a++,o--}let s=e[t+2];s.meta={...s.meta,columnCount:a}}}),c({name:`table tbody calculate`,tests:[{shift:0,type:`tbody_close`,hidden:!1}],transform:(e,t)=>{let n=t-2;for(;n>=0&&e[n].type!==`tbody_open`;)n--;let r=e[n].meta?.columnCount??0;if(r<2)return;let i=Array.from({length:r}).fill(0),a=[],o=n+1;for(;o<t;){let n=o,s=n+1;for(;s<t&&e[s].type!==`tr_close`;)s++;let c=[],l=n+1;for(;l<s;){let t=l+1;for(;t<s&&e[t].type!==`td_close`&&e[t].type!==`th_close`;)t++;c.push([l,t]),l=t+1}let u=0,d=0;for(;d<r;){if(i[d]>0){i[d]--,a.push(c[u]),u++,d++;continue}let t=e[c[u][0]],n=Number(t.attrGet(`colspan`))||1,o=Number(t.attrGet(`rowspan`))||1;u++;let s=0;for(let e=0;e<n;e++)if(d+e<r)if(i[d+e]===0)s++;else break;n>1&&s<n&&t.attrSet(`colspan`,String(s));for(let e=0;e<s;e++)d+e<r&&(i[d+e]=o-1);let l=s-1;if(l>0)for(let e=0;e<l;e++)a.push(c[u]),u++;d+=s}o=s+1}a.sort((e,t)=>t[0]-e[0]);for(let[t,n]of a)e.splice(t,n-t+1)}})],_=[`fence`,`inline`,`table`,`list`,`heading`,`hr`,`softbreak`,`block`],v=e=>{let t=e.rule===!1?[]:Array.isArray(e.rule)?e.rule.filter(e=>_.includes(e)):_,n=[];return t.includes(`fence`)&&n.push(u(e)),t.includes(`inline`)&&n.push(...f(e)),t.includes(`table`)&&n.push(...g(e)),t.includes(`list`)&&n.push(...p(e)),t.includes(`softbreak`)&&n.push(m(e)),t.includes(`hr`)&&n.push(h(e)),t.includes(`block`)?n.push(l(e)):t.includes(`heading`)&&n.push(d(e)),n},y=(e,{left:t=`{`,right:n=`}`,allowed:r=[],rule:i=`all`}={})=>{let a=v({left:t,right:n,allowed:r,rule:i});e.core.ruler.before(`linkify`,`attrs`,e=>{let t=e.tokens;for(let e=0;e<t.length;e++)for(let n=0;n<a.length;n++){let r=a[n],i=null,s=null;r.tests.every(n=>{let r=o(t,e,n);return r.position!==null&&({position:i}=r),r.range&&(s=r.range),r.match})&&(r.transform(t,e,i,s),(r.name===`inline attributes`||r.name===`inline nesting self-close`)&&n--)}})};export{y as attrs};
//# sourceMappingURL=browser.js.map