{"version":3,"file":"index.js","names":[],"sources":["../src/deflate/node.ts","../src/customBase64.ts","../src/plugin.ts"],"sourcesContent":["import { deflateRawSync } from \"node:zlib\";\n\nexport const deflate = (data: string): string =>\n  deflateRawSync(Buffer.from(data, \"utf8\"), { level: 9 }).toString(\"binary\");\n","/**\n * @see https://plantuml.com/en/text-encoding\n *\n * PlantUML uses a custom Base64 encoding scheme for text data.\n *\n * @param byte - 6-bit byte value\n * @returns encoded character\n */\nconst encode6bit = (byte: number): string =>\n  byte < 10\n    ? String.fromCharCode(48 + byte)\n    : byte < 36\n      ? String.fromCharCode(65 + byte - 10)\n      : byte < 62\n        ? String.fromCharCode(97 + byte - 36)\n        : byte === 62\n          ? \"-\"\n          : byte === 63\n            ? \"_\"\n            : \"?\";\n\nconst append3bytes = (b1: number, b2: number, b3: number): string => {\n  const c1 = b1 >> 2;\n  const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);\n  const c3 = ((b2 & 0xf) << 2) | (b3 >> 6);\n  const c4 = b3 & 0x3f;\n\n  return (\n    encode6bit(c1 & 0x3f) + encode6bit(c2 & 0x3f) + encode6bit(c3 & 0x3f) + encode6bit(c4 & 0x3f)\n  );\n};\n\n/**\n * Custom Base64 encoding for PlantUML\n *\n * Mapping: 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_\n *\n * @param data The input string to encode\n * @returns The Base64 encoded string\n */\nexport const customEncodeBase64 = (data: string): string => {\n  let result = \"\";\n\n  for (let i = 0; i < data.length; i += 3) {\n    if (i + 2 === data.length)\n      result += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), 0);\n    else if (i + 1 === data.length) result += append3bytes(data.charCodeAt(i), 0, 0);\n    else result += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), data.charCodeAt(i + 2));\n  }\n\n  return result;\n};\n","import { deflate } from \"@deflate\";\nimport { uml } from \"@mdit/plugin-uml\";\nimport type { Options, PluginWithOptions } from \"markdown-it\";\nimport type Renderer from \"markdown-it/lib/renderer.mjs\";\nimport type Token from \"markdown-it/lib/token.mjs\";\n\nimport { customEncodeBase64 } from \"./customBase64.js\";\nimport type { MarkdownItPlantumlOptions } from \"./options.js\";\n\nexport const plantuml: PluginWithOptions<MarkdownItPlantumlOptions> = (\n  md,\n  {\n    type = \"uml\",\n    name = \"uml\",\n    open = `start${name}`,\n    close = `end${name}`,\n    fence = name,\n    format = \"svg\",\n    server = \"https://www.plantuml.com/plantuml\",\n    srcGetter = (content: string): string =>\n      `${server}/${format}/${customEncodeBase64(\n        deflate(`@start${name}\\n${content.trim()}\\n@end${name}`),\n      )}`,\n    render = (\n      tokens: Token[],\n      index: number,\n      options: Options,\n      _env: unknown,\n      self: Renderer,\n    ): string => {\n      const token = tokens[index];\n      const { content, info } = token;\n\n      token.tag = \"img\";\n      token.attrPush([\"src\", srcGetter(content)]);\n      token.attrPush([\"alt\", info || \"PlantUML Diagram\"]);\n\n      return self.renderToken(tokens, index, options);\n    },\n  } = {},\n) => {\n  if (type === \"uml\") {\n    md.use(uml, {\n      name,\n      open,\n      close,\n      render,\n    });\n  } else {\n    // Handle ```name  blocks\n    // oxlint-disable-next-line typescript/no-non-null-assertion\n    const fenceRender = md.renderer.rules.fence!;\n\n    md.renderer.rules.fence = (\n      tokens: Token[],\n      index: number,\n      options: Options,\n      env: unknown,\n      self: Renderer,\n    ): string => {\n      const token = tokens[index];\n\n      const [fenceName, alt] = token.info.split(\" \", 2);\n\n      if (fenceName === fence) {\n        token.info = alt;\n\n        return render(tokens, index, options, env, self);\n      }\n\n      return fenceRender(tokens, index, options, env, self);\n    };\n  }\n};\n"],"mappings":"kFAEA,MAAa,EAAW,GACtB,EAAe,OAAO,KAAK,EAAM,OAAO,CAAE,CAAE,MAAO,EAAG,CAAC,CAAC,SAAS,SAAS,CCKtE,EAAc,GAClB,EAAO,GACH,OAAO,aAAa,GAAK,EAAK,CAC9B,EAAO,GACL,OAAO,aAAa,GAAK,EAAO,GAAG,CACnC,EAAO,GACL,OAAO,aAAa,GAAK,EAAO,GAAG,CACnC,IAAS,GACP,IACA,IAAS,GACP,IACA,IAER,GAAgB,EAAY,EAAY,IAAuB,CACnE,IAAM,EAAK,GAAM,EACX,GAAO,EAAK,IAAQ,EAAM,GAAM,EAChC,GAAO,EAAK,KAAQ,EAAM,GAAM,EAChC,EAAK,EAAK,GAEhB,OACE,EAAW,EAAK,GAAK,CAAG,EAAW,EAAK,GAAK,CAAG,EAAW,EAAK,GAAK,CAAG,EAAW,EAAK,GAAK,EAYpF,EAAsB,GAAyB,CAC1D,IAAI,EAAS,GAEb,IAAK,IAAI,EAAI,EAAG,EAAI,EAAK,OAAQ,GAAK,EAChC,EAAI,IAAM,EAAK,OACjB,GAAU,EAAa,EAAK,WAAW,EAAE,CAAE,EAAK,WAAW,EAAI,EAAE,CAAE,EAAE,CAC9D,EAAI,IAAM,EAAK,OAAQ,GAAU,EAAa,EAAK,WAAW,EAAE,CAAE,EAAG,EAAE,CAC3E,GAAU,EAAa,EAAK,WAAW,EAAE,CAAE,EAAK,WAAW,EAAI,EAAE,CAAE,EAAK,WAAW,EAAI,EAAE,CAAC,CAGjG,OAAO,GCzCI,GACX,EACA,CACE,OAAO,MACP,OAAO,MACP,OAAO,QAAQ,IACf,QAAQ,MAAM,IACd,QAAQ,EACR,SAAS,MACT,SAAS,oCACT,YAAa,GACX,GAAG,EAAO,GAAG,EAAO,GAAG,EACrB,EAAQ,SAAS,EAAK,IAAI,EAAQ,MAAM,CAAC,QAAQ,IAAO,CACzD,GACH,UACE,EACA,EACA,EACA,EACA,IACW,CACX,IAAM,EAAQ,EAAO,GACf,CAAE,UAAS,QAAS,EAM1B,MAJA,GAAM,IAAM,MACZ,EAAM,SAAS,CAAC,MAAO,EAAU,EAAQ,CAAC,CAAC,CAC3C,EAAM,SAAS,CAAC,MAAO,GAAQ,mBAAmB,CAAC,CAE5C,EAAK,YAAY,EAAQ,EAAO,EAAQ,GAE/C,EAAE,GACH,CACH,GAAI,IAAS,MACX,EAAG,IAAI,EAAK,CACV,OACA,OACA,QACA,SACD,CAAC,KACG,CAGL,IAAM,EAAc,EAAG,SAAS,MAAM,MAEtC,EAAG,SAAS,MAAM,OAChB,EACA,EACA,EACA,EACA,IACW,CACX,IAAM,EAAQ,EAAO,GAEf,CAAC,EAAW,GAAO,EAAM,KAAK,MAAM,IAAK,EAAE,CAQjD,OANI,IAAc,GAChB,EAAM,KAAO,EAEN,EAAO,EAAQ,EAAO,EAAS,EAAK,EAAK,EAG3C,EAAY,EAAQ,EAAO,EAAS,EAAK,EAAK"}