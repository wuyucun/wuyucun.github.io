const e=(e,t)=>e[t].meta.subId>0?`:${e[t].meta.subId}`:``,t=(e,t,n,r)=>`${typeof r.docId==`string`?`-${r.docId}-`:``}${(e[t].meta.id+1).toString()}`,n=(t,n)=>`[${(t[n].meta.id+1).toString()}${e(t,n)}]`,r=(t,n,r,i,a)=>{let o=a.rules.footnote_anchorName(t,n,r,i,a);return`<sup class="footnote-ref"><a href="#footnote${o}">${a.rules.footnote_caption(t,n,r,i,a)}</a><a class="footnote-anchor" id="footnote-ref${o}${e(t,n)}"></a></sup>`},i=(e,t,n)=>`\
<hr class="footnotes-sep"${n.xhtmlOut?` /`:``}>
<section class="footnotes">
<ol class="footnotes-list">
`,a=()=>`</ol>
</section>
`,o=(t,n,r,i,a)=>`<li id="footnote${a.rules.footnote_anchorName(t,n,r,i,a)}${e(t,n)}" class="footnote-item">`,s=()=>`</li>
`,c=(t,n,r,i,a)=>` <a href="#footnote-ref${a.rules.footnote_anchorName(t,n,r,i,a)}${e(t,n)}" class="footnote-backref">\u21A9\uFE0E</a>`,l=(e,t,n,r)=>{let i=e.bMarks[t]+e.tShift[t],a=e.eMarks[t],o;if(i+4>a||e.src.charCodeAt(i)!==91||e.src.charCodeAt(i+1)!==94)return!1;let s=i+2;for(;s<a;){if(o=e.src.charCodeAt(s),o===32)return!1;if(o===93)break;s++}if(s===i+2||s+1>=a||e.src.charCodeAt(++s)!==58)return!1;if(r)return!0;s++,(e.env.footnotes??={}).refs??={};let c=e.src.slice(i+2,s-2);e.env.footnotes.refs[`:${c}`]=-1;let l=e.push(`footnote_reference_open`,``,1);l.meta={label:c},l.level=e.level++;let u=e.bMarks[t],d=e.tShift[t],f=e.sCount[t],p=e.parentType,m=s,h=e.sCount[t]+s-(e.bMarks[t]+e.tShift[t]),g=h;for(;s<a;){let t=e.src.charCodeAt(s);if(t===9)g+=4-g%4;else if(t===32)g++;else break;s++}e.tShift[t]=s-m,e.sCount[t]=g-h,e.bMarks[t]=m,e.blkIndent+=4,e.parentType=`footnote`,e.sCount[t]<e.blkIndent&&(e.sCount[t]+=e.blkIndent),e.md.block.tokenize(e,t,n),e.parentType=p,e.blkIndent-=4,e.tShift[t]=d,e.sCount[t]=f,e.bMarks[t]=u;let _=e.push(`footnote_reference_close`,``,-1);return _.level=--e.level,!0},u=(e,t)=>{let n=e.posMax,r=e.pos;if(r+2>=n||e.src.charCodeAt(r)!==94||e.src.charCodeAt(r+1)!==91)return!1;let i=e.md.helpers.parseLinkLabel(e,r+1);if(i<0)return!1;let a=r+2;if(!t){let t=((e.env.footnotes??={}).list??=[]).length,n=[];e.md.inline.parse(e.src.slice(a,i),e.md,e.env,n);let r=e.push(`footnote_ref`,``,0);r.meta={id:t},e.env.footnotes.list[t]={content:e.src.slice(a,i),tokens:n}}return e.pos=i+1,e.posMax=n,!0},d=(e,t)=>{let n=e.pos,r=e.posMax,i;if(n+3>r||!e.env.footnotes?.refs||e.src.charCodeAt(n)!==91||e.src.charCodeAt(n+1)!==94)return!1;let a=n+2;for(;a<r;){if(i=e.src.charCodeAt(a),i===32||i===10)return!1;if(i===93)break;a++}if(a===n+2||a>=r)return!1;a++;let o=e.src.slice(n+2,a-1);if(e.env.footnotes.refs[`:${o}`]===void 0)return!1;if(!t){let t=e.env.footnotes.list??=[],{refs:n}=e.env.footnotes,r;n[`:${o}`]<0?(r=t.length,t[r]={label:o,count:0},n[`:${o}`]=r):r=n[`:${o}`];let i=t[r].count;t[r].count+=1;let a=e.push(`footnote_ref`,``,0);a.meta={id:r,subId:i,label:o}}return e.pos=a,e.posMax=r,!0},f=e=>{let t={},n,r,i=!1;if(!e.env.footnotes?.list)return e.tokens=e.tokens.filter(e=>e.type===`footnote_reference_open`?(i=!0,!1):e.type===`footnote_reference_close`?(i=!1,!1):!i),!1;let{list:a}=e.env.footnotes;e.tokens=e.tokens.filter(e=>e.type===`footnote_reference_open`?(i=!0,n=[],r=e.meta.label,!1):e.type===`footnote_reference_close`?(i=!1,t[`:${r}`]=n,!1):(i&&n.push(e),!i));let o=new e.Token(`footnote_block_open`,``,1);e.tokens.push(o);for(let n=0,{length:r}=a;n<r;n++){let r=new e.Token(`footnote_open`,``,1);r.meta={id:n,label:a[n].label},e.tokens.push(r);let i;if(a[n].tokens){let t=new e.Token(`paragraph_open`,`p`,1);t.block=!0;let r=new e.Token(`inline`,``,0);r.children=a[n].tokens,r.content=a[n].content;let i=new e.Token(`paragraph_close`,`p`,-1);i.block=!0,e.tokens.push(t,r,i)}else if(a[n].label){let r=t[`:${a[n].label}`];r&&e.tokens.push(...r)}i=e.tokens[e.tokens.length-1].type===`paragraph_close`?e.tokens.pop()??null:null;for(let t=0;t<(Number(a[n].count)>0?a[n].count:1);t++){let r=new e.Token(`footnote_anchor`,``,0);r.meta={id:n,subId:t,label:a[n].label},e.tokens.push(r)}i&&e.tokens.push(i),e.tokens.push(new e.Token(`footnote_close`,``,-1))}return e.tokens.push(new e.Token(`footnote_block_close`,``,-1)),!0},p=e=>{e.renderer.rules.footnote_ref=r,e.renderer.rules.footnote_block_open=i,e.renderer.rules.footnote_block_close=a,e.renderer.rules.footnote_open=o,e.renderer.rules.footnote_close=s,e.renderer.rules.footnote_anchor=c,e.renderer.rules.footnote_caption=n,e.renderer.rules.footnote_anchorName=t,e.block.ruler.before(`reference`,`footnoteDef`,l,{alt:[`paragraph`,`reference`]}),e.inline.ruler.after(`image`,`footnoteInline`,u),e.inline.ruler.after(`footnoteInline`,`footnote_ref`,d),e.core.ruler.after(`inline`,`footnoteTail`,f)};export{p as footnote};
//# sourceMappingURL=index.js.map